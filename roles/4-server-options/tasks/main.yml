# Server Options

- name: ...IS BEGINNING ==================================
  file:
    path: "{{ iiab_state_file }}"
    state: touch

- name: Install named / BIND
  include_tasks: roles/network/tasks/named.yml
  when: named_install | bool

- name: Installing dhcpd
  include_tasks: roles/network/tasks/dhcpd.yml
  when: dhcpd_install | bool

- name: Install Squid (and DansGuardian if dansguardian_install)
  include_tasks: roles/network/tasks/squid.yml
  when: squid_install | bool

- name: Install Bluetooth - only on Raspberry Pi
  include_role:
    name: bluetooth
  when: is_rpi and bluetooth_install

- name: USB_LIB
  include_role:
    name: usb_lib
  when: usb_lib_install | bool

# 2020-02-12: what was roles/homepage lives in roles/web_support & roles/httpd
# for now.  Eventually softcoding of iiab_home_url should happen everywhere
# (incl Admin Console) to allow more field options, e.g. changing
# /library/www/html/home even when offline...

- name: CUPS
  include_role:
    name: cups
  when: cups_install | bool

- name: SAMBA
  include_role:
    name: samba
  when: samba_install | bool

# 2020-02-12: DOES THE FLAG BELOW (apache_allow_sudo) WORK WITH NGINX TOO ?
# COMPARE apache_high_php_limits @ web_support/tasks/main.yml

- name: Give {{ apache_user }} (per variable apache_user) permission to poweroff, installing /etc/sudoers.d/020_apache_poweroff from template
  template:
    src: roles/web_support/templates/020_apache_poweroff.j2
    dest: /etc/sudoers.d/020_apache_poweroff
    mode: '0755'
  when: apache_allow_sudo | bool

- name: Remove {{ apache_user }} (per variable apache_user) permission to poweroff, removing /etc/sudoers.d/020_apache_poweroff
  file:
    path: /etc/sudoers.d/020_apache_poweroff
    state: absent
  when: not apache_allow_sudo

- name: Run /usr/bin/iiab-refresh-wiki-docs (scraper script) to create http://box/info offline documentation.  (This script was installed in Stage 3 = roles/3-base-server/tasks/main.yml, which ran roles/web_support/tasks/main.yml)
  command: /usr/bin/iiab-refresh-wiki-docs
  when: internet_available and not nodocs

- name: Recording STAGE 4 HAS COMPLETED ==================
  lineinfile:
    path: "{{ iiab_env_file }}"
    regexp: '^STAGE=*'
    line: 'STAGE=4'
