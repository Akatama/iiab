name: '"40 min" IIAB "Small" on RPi 5'

on: [push, pull_request, workflow_dispatch]

jobs:
  test-install:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0    # Default is 1, but iiab-summary (below) needs git tag history.
      - name: Set up /opt/iiab/iiab
        run: |
          mkdir /opt/iiab
          mv $GITHUB_WORKSPACE /opt/iiab
          # Github Actions is weird, do not delete the line below. Yes, it will cause everything to break. Really.
          mkdir $GITHUB_WORKSPACE
      - uses: pguyot/arm-runner-action@v2
        with:
          image_additional_mb: 10240
          cpu: cortex-a76
          cpu_info: cpuinfo/raspberrypi_5
          base_image: raspios_lite_arm64:latest
          # source https://www.raspberrypi.com/software/operating-systems/
          copy_repository_path: /opt/iiab/iiab
          commands: |
              echo "ðŸ This job's status is ${{ job.status }}."
              # /proc/cpuinfo not available on ubuntu-24.04 runner, per https://github.com/pguyot/arm-runner-action#cpu_info
              # grep Model /proc/cpuinfo
              uname -a    # uname -srm
              whoami      # Typically 'root' instead of 'runner'
              pwd         # /home/runner/work/iiab/iiab == $GITHUB_WORKSPACE == ${{ github.workspace }}
              cat /etc/os-release
              apt-get update -y --allow-releaseinfo-change
              #apt-get upgrade
              apt-get install --no-install-recommends -y git curl
              ls /opt/iiab/iiab
              mkdir /etc/iiab
              cat > /etc/iiab/local_vars.yml << EOL
              remoteit_install: False
              tailscale_install: False
              kolibri_install: False
              kolibri_enabled: False
              kiwix_install: False
              kiwix_enabled: False
              osm_vector_maps_install: False
              maps_install: False
              awstats_install: False
              awstats_enabled: False
              matomo_install: True
              matomo_enabled: True
              captiveportal_install: False
              calibreweb_install: False
              calibreweb_enabled: False
              EOL
              /opt/iiab/iiab/scripts/ansible
              sudo ./iiab-install
              cd /opt/iiab/iiab
              iiab-summary
              cat /etc/iiab/iiab_state.yml
      - name: Cat /root/.my.cnf
        if: always()
        run: sudo cat /root/.my.cnf

